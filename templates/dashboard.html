<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AutoPod Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1a1f3a 100%);
      color: #e2e8f0;
      min-height: 100vh;
      padding: 0;
    }

    /* Header/Navigation */
    header {
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(148, 163, 184, 0.1);
      padding: 1.5rem 2rem;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    header h1 {
      font-size: 1.75rem;
      font-weight: 700;
      background: linear-gradient(135deg, #06b6d4 0%, #0ea5e9 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 0;
    }

    /* Main Container */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    /* Section Styling */
    .section {
      background: rgba(30, 41, 59, 0.6);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(148, 163, 184, 0.1);
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
    }

    .section:hover {
      border-color: rgba(6, 182, 212, 0.2);
      box-shadow: 0 12px 40px rgba(6, 182, 212, 0.1);
    }

    .section h2 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      color: #f1f5f9;
      border-bottom: 2px solid rgba(6, 182, 212, 0.3);
      padding-bottom: 1rem;
    }

    /* Actions Grid */
    .actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    /* Button Styling */
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      white-space: nowrap;
      background: linear-gradient(135deg, #06b6d4 0%, #0ea5e9 100%);
      color: #0f172a;
      box-shadow: 0 4px 15px rgba(6, 182, 212, 0.3);
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(6, 182, 212, 0.4);
    }

    .btn:active:not(:disabled) {
      transform: translateY(0);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
    }

    .btn-danger:hover:not(:disabled) {
      box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
    }

    .btn-warning {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
    }

    .btn-warning:hover:not(:disabled) {
      box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
    }

    .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }

    .btn-success:hover:not(:disabled) {
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }

    /* Status Messages */
    .sync-status {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 10px;
      font-weight: 600;
      display: none;
      animation: slideIn 0.3s ease;
    }

    .sync-status.active {
      display: block;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .status-success {
      background: rgba(16, 185, 129, 0.1);
      color: #6ee7b7;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .status-error {
      background: rgba(239, 68, 68, 0.1);
      color: #fca5a5;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }


    /* Status Items */
    .status-item {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 1.25rem;
      background: rgba(51, 65, 85, 0.4);
      border-radius: 12px;
      margin-bottom: 1rem;
      border: 1px solid rgba(148, 163, 184, 0.1);
      transition: all 0.3s ease;
    }

    .status-item:hover {
      background: rgba(51, 65, 85, 0.6);
      border-color: rgba(6, 182, 212, 0.2);
    }

    .status-info {
      flex-grow: 1;
    }

    .status-name {
      font-weight: 700;
      color: #06b6d4;
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }

    .status-details {
      font-size: 0.85rem;
      color: #94a3b8;
      margin-bottom: 0.75rem;
      line-height: 1.5;
    }

    .status-badge {
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-running {
      background: rgba(16, 185, 129, 0.2);
      color: #6ee7b7;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .status-exited {
      background: rgba(239, 68, 68, 0.2);
      color: #fca5a5;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .status-created {
      background: rgba(59, 130, 246, 0.2);
      color: #93c5fd;
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .status-paused {
      background: rgba(245, 158, 11, 0.2);
      color: #fcd34d;
      border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .status-unknown {
      background: rgba(148, 163, 184, 0.2);
      color: #cbd5e1;
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    /* Container Actions */
    .container-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }

    .container-actions .btn {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
    }

    /* Logs */
    pre {
      background: rgba(15, 23, 42, 0.8);
      padding: 1.5rem;
      border-radius: 12px;
      overflow-x: auto;
      color: #6ee7b7;
      max-height: 500px;
      overflow-y: auto;
      border: 1px solid rgba(148, 163, 184, 0.1);
      font-family: "Fira Code", "Courier New", monospace;
      font-size: 0.9rem;
      line-height: 1.6;
    }

    pre::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    pre::-webkit-scrollbar-track {
      background: rgba(148, 163, 184, 0.1);
      border-radius: 10px;
    }

    pre::-webkit-scrollbar-thumb {
      background: rgba(6, 182, 212, 0.3);
      border-radius: 10px;
    }

    pre::-webkit-scrollbar-thumb:hover {
      background: rgba(6, 182, 212, 0.5);
    }

    /* Webhook Section */
    .webhook-section {
      background: rgba(6, 182, 212, 0.05);
      padding: 1.5rem;
      border-radius: 12px;
      border: 1px solid rgba(6, 182, 212, 0.2);
      margin-top: 1.5rem;
    }

    .webhook-section p {
      color: #cbd5e1;
      margin-bottom: 1.5rem;
      font-size: 0.95rem;
    }

    .webhook-input {
      width: 100%;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(6, 182, 212, 0.3);
      border-radius: 10px;
      padding: 0.75rem 1rem;
      color: #e2e8f0;
      margin: 0.75rem 0;
      font-family: "Fira Code", "Courier New", monospace;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }

    .webhook-input:focus {
      outline: none;
      border-color: rgba(6, 182, 212, 0.6);
      background: rgba(15, 23, 42, 0.8);
      box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
    }

    .webhook-input::placeholder {
      color: #64748b;
    }

    /* Input Labels */
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #cbd5e1;
      font-size: 0.95rem;
    }

    .input-group {
      margin-bottom: 1.25rem;
    }

    .input-hint {
      font-size: 0.8rem;
      color: #64748b;
      margin-top: 0.5rem;
    }

    /* Container Count Badge */
    .container-count {
      background: linear-gradient(135deg, #06b6d4 0%, #0ea5e9 100%);
      color: #0f172a;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 700;
      display: inline-block;
    }

    /* Last Updated */
    .last-updated {
      text-align: right;
      font-size: 0.85rem;
      color: #64748b;
      margin-top: 1rem;
      font-style: italic;
    }

    /* Health Monitoring Grid */
    .health-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 1.5rem;
    }

    .health-card {
      background: rgba(51, 65, 85, 0.4);
      border-radius: 12px;
      padding: 1.5rem;
      border: 1px solid rgba(148, 163, 184, 0.1);
      transition: all 0.3s ease;
    }

    .health-card:hover {
      border-color: rgba(6, 182, 212, 0.2);
      background: rgba(51, 65, 85, 0.6);
    }

    .metric-item {
      padding: 0.75rem;
      background: rgba(15, 23, 42, 0.4);
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.1);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }

      .section {
        padding: 1.5rem;
      }

      .actions {
        grid-template-columns: 1fr;
      }

      .health-grid {
        grid-template-columns: 1fr;
      }

      header h1 {
        font-size: 1.5rem;
      }

      .section h2 {
        font-size: 1.25rem;
      }

      .status-item {
        flex-direction: column;
      }

      .container-actions {
        flex-direction: column;
      }

      .container-actions .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>🚀 AutoPod Intelligent Container Dashboard</h1>
  </header>

  <div class="container">
    <!-- Actions Section -->
    <div class="section">
      <h2>⚡ Quick Actions</h2>
      <div class="actions">
        <button class="btn" onclick="syncContainers()" id="sync-btn">
          🔄 Sync Containers
        </button>
        <button class="btn" onclick="refreshData()" id="refresh-btn">
          📊 Refresh Data
        </button>
        <button class="btn" onclick="clearLogs()" id="clear-logs-btn">
          🧹 Clear Logs
        </button>
        <button class="btn btn-success" onclick="testWebhook()" id="test-webhook-btn">
          🚀 Test Webhook
        </button>
      </div>
      <div id="sync-status" class="sync-status"></div>
      <div id="last-updated" class="last-updated"></div>
    </div>

    <!-- Webhook Testing Section -->
    <div class="section">
      <h2>🌐 Webhook & Deployment</h2>
      <div class="webhook-section">
        <p>Deploy containers directly from GitHub repositories with AutoPod automation.</p>
        
        <div class="input-group">
          <label for="github-url">📋 GitHub Repository URL</label>
          <input 
            type="text" 
            id="github-url" 
            class="webhook-input" 
            placeholder="https://github.com/username/repository.git"
          >
          <div class="input-hint">Enter any public GitHub repository URL with a Dockerfile</div>
        </div>

        <div class="input-group">
          <label for="app-name">🏷️ Application Name</label>
          <input 
            type="text" 
            id="app-name" 
            class="webhook-input" 
            placeholder="my-app"
          >
          <div class="input-hint">Auto-filled from repository name if left empty</div>
        </div>

        <div class="actions">
          <button class="btn btn-success" onclick="triggerCustomWebhook()">
            🚀 Deploy from GitHub
          </button>
          <button class="btn" onclick="triggerSampleWebhook()">
            🧪 Test with Sample
          </button>
        </div>

        <div id="webhook-status" class="sync-status"></div>
      </div>
    </div>

    <!-- Container Status Section -->
    <div class="section">
      <h2>
        📦 Container Status
        <span id="container-count" class="container-count">0</span>
      </h2>
      <div id="status">Loading containers...</div>
    </div>

    <!-- Container Logs Section -->
    <div class="section">
      <h2>📝 Container Logs</h2>
      <pre id="logs">Loading logs...</pre>
    </div>

    <!-- Health Monitoring Section -->
    <div class="section">
      <h2>
        💚 Container Health Monitoring
        <span id="health-count" class="container-count">0</span>
      </h2>
      <div class="actions">
        <button class="btn" onclick="refreshHealth()" id="refresh-health-btn">
          📊 Refresh Health Data
        </button>
        <button class="btn btn-success" onclick="startHealthMonitoring()">
          🔄 Start Auto-Refresh
        </button>
        <button class="btn btn-warning" onclick="stopHealthMonitoring()">
          ⏹️ Stop Auto-Refresh
        </button>
      </div>
      <div id="health-monitoring" style="margin-top: 1.5rem;">
        <div id="health-status">Loading health data...</div>
      </div>
    </div>
  </div>

  <script>
    let lastUpdateTime = null;

    function getStatusBadge(status) {
      const statusLower = status.toLowerCase();
      if (statusLower.includes('running') || statusLower.includes('up')) {
        return 'status-running';
      } else if (statusLower.includes('exited') || statusLower.includes('stopped')) {
        return 'status-exited';
      } else if (statusLower.includes('created')) {
        return 'status-created';
      } else if (statusLower.includes('paused')) {
        return 'status-paused';
      } else {
        return 'status-unknown';
      }
    }

    function getStatusText(status) {
      const statusLower = status.toLowerCase();
      if (statusLower.includes('running') || statusLower.includes('up')) {
        return 'Running';
      } else if (statusLower.includes('exited') || statusLower.includes('stopped')) {
        return 'Exited';
      } else if (statusLower.includes('created')) {
        return 'Created';
      } else if (statusLower.includes('paused')) {
        return 'Paused';
      } else {
        return status;
      }
    }

    function updateLastUpdated() {
      lastUpdateTime = new Date();
      const lastUpdatedDiv = document.getElementById('last-updated');
      lastUpdatedDiv.textContent = `Last updated: ${lastUpdateTime.toLocaleTimeString()}`;
    }

    // Container Management Functions
    async function startContainer(containerName) {
      const statusDiv = document.getElementById('sync-status');
      statusDiv.className = 'sync-status active status-info';
      statusDiv.innerHTML = `Starting container: ${containerName}...`;
      
      try {
        const response = await fetch('/api/containers/start', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ container_name: containerName })
        });
        
        const result = await response.json();
        if (result.success) {
          statusDiv.className = 'sync-status active status-success';
          statusDiv.innerHTML = `✅ Container ${containerName} started successfully`;
          setTimeout(fetchData, 2000);
        } else {
          statusDiv.className = 'sync-status active status-error';
          statusDiv.innerHTML = `❌ Failed to start ${containerName}: ${result.error}`;
        }
      } catch (err) {
        statusDiv.className = 'sync-status active status-error';
        statusDiv.innerHTML = `❌ Error starting container: ${err.message}`;
      }
    }

    async function stopContainer(containerName) {
      const statusDiv = document.getElementById('sync-status');
      statusDiv.className = 'sync-status active status-info';
      statusDiv.innerHTML = `Stopping container: ${containerName}...`;
      
      try {
        const response = await fetch('/api/containers/stop', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ container_name: containerName })
        });
        
        const result = await response.json();
        if (result.success) {
          statusDiv.className = 'sync-status active status-success';
          statusDiv.innerHTML = `✅ Container ${containerName} stopped successfully`;
          setTimeout(fetchData, 2000);
        } else {
          statusDiv.className = 'sync-status active status-error';
          statusDiv.innerHTML = `❌ Failed to stop ${containerName}: ${result.error}`;
        }
      } catch (err) {
        statusDiv.className = 'sync-status active status-error';
        statusDiv.innerHTML = `❌ Error stopping container: ${err.message}`;
      }
    }

    async function restartContainer(containerName) {
      const statusDiv = document.getElementById('sync-status');
      statusDiv.className = 'sync-status active status-info';
      statusDiv.innerHTML = `Restarting container: ${containerName}...`;
      
      try {
        const response = await fetch('/api/containers/restart', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ container_name: containerName })
        });
        
        const result = await response.json();
        if (result.success) {
          statusDiv.className = 'sync-status active status-success';
          statusDiv.innerHTML = `✅ Container ${containerName} restarted successfully`;
          setTimeout(fetchData, 2000);
        } else {
          statusDiv.className = 'sync-status active status-error';
          statusDiv.innerHTML = `❌ Failed to restart ${containerName}: ${result.error}`;
        }
      } catch (err) {
        statusDiv.className = 'sync-status active status-error';
        statusDiv.innerHTML = `❌ Error restarting container: ${err.message}`;
      }
    }

    async function removeContainer(containerName) {
      if (!confirm(`Are you sure you want to remove container ${containerName}?`)) {
        return;
      }
      
      const statusDiv = document.getElementById('sync-status');
      statusDiv.className = 'sync-status active status-info';
      statusDiv.innerHTML = `Removing container: ${containerName}...`;
      
      try {
        const response = await fetch('/api/containers/remove', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ container_name: containerName })
        });
        
        const result = await response.json();
        if (result.success) {
          statusDiv.className = 'sync-status active status-success';
          statusDiv.innerHTML = `✅ Container ${containerName} removed successfully`;
          setTimeout(fetchData, 2000);
        } else {
          statusDiv.className = 'sync-status active status-error';
          statusDiv.innerHTML = `❌ Failed to remove ${containerName}: ${result.error}`;
        }
      } catch (err) {
        statusDiv.className = 'sync-status active status-error';
        statusDiv.innerHTML = `❌ Error removing container: ${err.message}`;
      }
    }

    // Sync and Refresh Functions
    async function syncContainers() {
      const syncBtn = document.getElementById('sync-btn');
      const statusDiv = document.getElementById('sync-status');
      
      syncBtn.disabled = true;
      syncBtn.innerHTML = '⏳ Syncing...';
      statusDiv.className = 'sync-status active status-info';
      statusDiv.innerHTML = 'Syncing containers with database...';
      
      try {
        const response = await fetch('/api/sync', { 
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        const result = await response.json();
        
        if (result.success) {
          statusDiv.className = 'sync-status active status-success';
          statusDiv.innerHTML = '✅ Sync successful! Refreshing data...';
          setTimeout(fetchData, 1000);
        } else {
          statusDiv.className = 'sync-status active status-error';
          statusDiv.innerHTML = `❌ Sync failed: ${result.error}`;
        }
      } catch (err) {
        statusDiv.className = 'sync-status active status-error';
        statusDiv.innerHTML = `❌ Sync error: ${err.message}`;
      } finally {
        syncBtn.disabled = false;
        syncBtn.innerHTML = '🔄 Sync Containers';
        
        setTimeout(() => {
          statusDiv.innerHTML = '';
          statusDiv.className = 'sync-status';
        }, 5000);
      }
    }

    function refreshData() {
      const refreshBtn = document.getElementById('refresh-btn');
      refreshBtn.disabled = true;
      refreshBtn.innerHTML = '⏳ Refreshing...';
      
      fetchData();
      
      setTimeout(() => {
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = '📊 Refresh Data';
      }, 1000);
    }

    function clearLogs() {
      const logsPre = document.getElementById('logs');
      logsPre.textContent = 'Logs cleared. New logs will appear here...';
    }

    // Webhook Functions
    async function triggerCustomWebhook() {
      const githubUrl = document.getElementById('github-url').value;
      const appName = document.getElementById('app-name').value || 'auto-deployed-app';
      const statusDiv = document.getElementById('webhook-status');
      
      if (!githubUrl) {
        statusDiv.className = 'sync-status active status-error';
        statusDiv.innerHTML = '❌ Please enter a GitHub repository URL';
        return;
      }

      statusDiv.className = 'sync-status active status-info';
      statusDiv.innerHTML = `🚀 Deploying from GitHub: ${githubUrl}`;
      
      try {
        const response = await fetch('/webhook', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            repository: {
              clone_url: githubUrl,
              name: appName
            },
            after: "auto-deploy-" + Date.now()
          })
        });
        
        const result = await response.json();
        if (result.status === 'success') {
          statusDiv.className = 'sync-status active status-success';
          statusDiv.innerHTML = '✅ Deployment started! Container will appear shortly.';
          setTimeout(fetchData, 3000);
        } else {
          statusDiv.className = 'sync-status active status-error';
          statusDiv.innerHTML = `❌ Deployment failed: ${result.message}`;
        }
      } catch (err) {
        statusDiv.className = 'sync-status active status-error';
        statusDiv.innerHTML = `❌ Deployment error: ${err.message}`;
      }
    }

    async function triggerSampleWebhook() {
      const statusDiv = document.getElementById('webhook-status');
      statusDiv.className = 'sync-status active status-info';
      statusDiv.innerHTML = '🚀 Triggering sample webhook deployment...';
      
      try {
        const response = await fetch('/webhook', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            repository: {
              clone_url: "https://github.com/nginx/nginx.git",
              name: "sample-auto-app"
            },
            after: "sample-deploy-" + Date.now()
          })
        });
        
        const result = await response.json();
        if (result.status === 'success') {
          statusDiv.className = 'sync-status active status-success';
          statusDiv.innerHTML = '✅ Sample deployment started! Check for new containers.';
          setTimeout(fetchData, 3000);
        } else {
          statusDiv.className = 'sync-status active status-error';
          statusDiv.innerHTML = `❌ Sample deployment failed: ${result.message}`;
        }
      } catch (err) {
        statusDiv.className = 'sync-status active status-error';
        statusDiv.innerHTML = `❌ Sample deployment error: ${err.message}`;
      }
    }

    function getRepoNameFromUrl(url) {
      try {
        const match = url.match(/github\.com\/([^\/]+\/[^\/]+?)(?:\.git)?$/);
        return match ? match[1].replace('/', '-') : 'github-app';
      } catch {
        return 'github-app';
      }
    }

    document.getElementById('github-url').addEventListener('input', function(e) {
      const url = e.target.value;
      const appNameInput = document.getElementById('app-name');
      if (url && !appNameInput.value) {
        appNameInput.value = getRepoNameFromUrl(url);
      }
    });

    async function testWebhook() {
      const statusDiv = document.getElementById('sync-status');
      statusDiv.className = 'sync-status active status-info';
      statusDiv.innerHTML = 'Testing webhook functionality...';
      
      try {
        const response = await fetch('/webhook', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            test: "simple webhook test"
          })
        });
        
        const result = await response.json();
        if (result.status === 'success') {
          statusDiv.className = 'sync-status active status-success';
          statusDiv.innerHTML = '✅ Webhook test successful! Check for new containers.';
          setTimeout(fetchData, 3000);
        } else {
          statusDiv.className = 'sync-status active status-error';
          statusDiv.innerHTML = `❌ Webhook test failed: ${result.message}`;
        }
      } catch (err) {
        statusDiv.className = 'sync-status active status-error';
        statusDiv.innerHTML = `❌ Webhook test error: ${err.message}`;
      }
    }

    // Main Data Fetching Function
    async function fetchData() {
      try {
        const [statusRes, logsRes] = await Promise.all([
          fetch('http://127.0.0.1:5000/api/status'),
          fetch('http://127.0.0.1:5000/api/logs')
        ]);

        const statusData = await statusRes.json();
        const logsData = await logsRes.json();

        // Status Section
        const statusDiv = document.getElementById('status');
        const containerCount = document.getElementById('container-count');
        
        if (statusData.success && statusData.data.length > 0) {
          containerCount.textContent = statusData.data.length;
          statusDiv.innerHTML = `
            <div>
              ${statusData.data.map(container => `
                <div class="status-item">
                  <div class="status-info">
                    <div class="status-name">${container['container_name']}</div>
                    <div class="status-details">
                      Status: ${container['status']} | Created: ${new Date(container['created_at']).toLocaleString()}
                    </div>
                    <div class="container-actions">
                      <button class="btn btn-success" onclick="startContainer('${container['container_name']}')" 
                              ${container['status'].toLowerCase().includes('running') ? 'disabled' : ''}>
                        ▶️ Start
                      </button>
                      <button class="btn btn-warning" onclick="stopContainer('${container['container_name']}')"
                              ${!container['status'].toLowerCase().includes('running') ? 'disabled' : ''}>
                        ⏹️ Stop
                      </button>
                      <button class="btn" onclick="restartContainer('${container['container_name']}')"
                              ${!container['status'].toLowerCase().includes('running') ? 'disabled' : ''}>
                        🔄 Restart
                      </button>
                      <button class="btn btn-danger" onclick="removeContainer('${container['container_name']}')">
                        🗑️ Remove
                      </button>
                    </div>
                  </div>
                  <span class="status-badge ${getStatusBadge(container['status'])}">
                    ${getStatusText(container['status'])}
                  </span>
                </div>
              `).join('')}
            </div>
          `;
        } else {
          containerCount.textContent = '0';
          statusDiv.innerHTML = '<p style="color: #94a3b8; text-align: center; padding: 2rem;">No containers found. Click "Sync Containers" to refresh or "Test Webhook" to deploy a sample container.</p>';
        }

        // Logs Section
        const logsPre = document.getElementById('logs');
        if (logsData.success && logsData.data.length > 0) {
          logsPre.textContent = logsData.data.map(log => 
            `[${log['timestamp']}] ${log['container_name'] || 'unknown'}: ${log['log']}`
          ).join('\n');
          logsPre.scrollTop = logsPre.scrollHeight;
        } else {
          logsPre.textContent = 'No logs available. Start containers or trigger a webhook to see logs.';
        }

        updateLastUpdated();

      } catch (err) {
        console.error('Error fetching data:', err);
        document.getElementById('status').innerHTML = 
          '<p style="color: #fca5a5; text-align: center; padding: 2rem;">Error loading container status. Check if the server is running.</p>';
        document.getElementById('logs').textContent = 'Error loading logs. Check console for details.';
        document.getElementById('container-count').textContent = '0';
        
        const statusDiv = document.getElementById('sync-status');
        statusDiv.className = 'sync-status active status-error';
        statusDiv.innerHTML = '❌ Connection error. Make sure the backend server is running on port 5000.';
      }
    }

    // Fetch data every 5 seconds
    fetchData();
    setInterval(fetchData, 5000);

    // Initial update time
    updateLastUpdated();

    let healthMonitorInterval = null;

    // Health Monitoring Functions
    async function refreshHealth() {
        const refreshBtn = document.getElementById('refresh-health-btn');
        const healthContainer = document.getElementById('health-status');
        
        refreshBtn.disabled = true;
        refreshBtn.innerHTML = '⏳ Loading...';
        
        try {
            const response = await fetch('/api/containers/health');
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const result = await response.json();
            
            if (result.success && result.data) {
                displayHealthData(result.data);
            } else {
                healthContainer.innerHTML = `
                    <div style="background: rgba(239, 68, 68, 0.1); padding: 1.5rem; border-radius: 10px; border: 1px solid rgba(239, 68, 68, 0.3);">
                        <h4 style="color: #fca5a5; margin: 0 0 0.75rem 0;">❌ Error Loading Health Data</h4>
                        <p style="margin: 0; color: #cbd5e1;">Error: ${result.error || 'Unknown error'}</p>
                    </div>
                `;
            }
        } catch (err) {
            healthContainer.innerHTML = `
                <div style="background: rgba(239, 68, 68, 0.1); padding: 1.5rem; border-radius: 10px; border: 1px solid rgba(239, 68, 68, 0.3);">
                    <h4 style="color: #fca5a5; margin: 0 0 0.75rem 0;">❌ Network Error</h4>
                    <p style="margin: 0; color: #cbd5e1;">${err.message}</p>
                    <p style="margin: 0.75rem 0 0 0; font-size: 0.8rem; color: #64748b;">
                        Make sure the Flask server is running on port 5000.
                    </p>
                </div>
            `;
        } finally {
            refreshBtn.disabled = false;
            refreshBtn.innerHTML = '📊 Refresh Health Data';
        }
    }

    function displayHealthData(healthData) {
        const healthContainer = document.getElementById('health-status');
        const healthCount = document.getElementById('health-count');
        
        if (!healthData || Object.keys(healthData).length === 0) {
            healthContainer.innerHTML = '<p style="color: #94a3b8; text-align: center;">No containers found for health monitoring.</p>';
            healthCount.textContent = '0';
            return;
        }
        
        healthCount.textContent = Object.keys(healthData).length;
        
        let html = '<div class="health-grid">';
        
        Object.entries(healthData).forEach(([containerName, data]) => {
            const health = data.health || {};
            const resources = data.resources || {};
            const basicInfo = data.basic_info || {};
            
            const healthStatus = health.status || 'unknown';
            const healthColor = getHealthStatusColor(healthStatus);
            const healthIcon = getHealthStatusIcon(healthStatus);
            const cpuUsage = resources.cpu_percent || '0%';
            const memoryUsage = resources.memory_usage || '0B';
            const memoryLimit = resources.memory_limit || 'N/A';
            const networkIO = resources.network_io || '0B / 0B';
            const restartCount = resources.restart_count || 0;
            const pids = resources.pids || '0';
            const createdDate = resources.created_at || basicInfo.created || 'unknown';
            
            let displayDate = createdDate;
            if (typeof createdDate === 'number' && createdDate > 1000000000) {
                displayDate = new Date(createdDate * 1000).toLocaleString();
            }
            
            const isInferred = health.inferred;

            html += `
                <div class="health-card" style="border-left: 4px solid ${healthColor};">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="font-size: 1.25rem;">${healthIcon}</span>
                                <h4 style="margin: 0; color: #06b6d4; font-size: 1.24rem;">${containerName}</h4>
                            </div>
                            <div style="font-size: 1rem; color: #94a3b8; line-height: 1.5 gap: 2 rem;">
                                <div>📦 ${basicInfo.image || 'unknown'}</div>
                                <div>🔄 ${basicInfo.status || 'unknown'}</div>
                                <div>🕒 ${displayDate}</div>
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;">
                            <div style="background: ${healthColor}; color: white; padding: 0.35rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">
                                ${healthStatus.toUpperCase()}
                            </div>
                            ${isInferred ? `
                                <div style="background: rgba(245, 158, 11, 0.2); color: #fcd34d; padding: 0.25rem 0.5rem; border-radius: 8px; font-size: 0.7rem; border: 1px solid rgba(245, 158, 11, 0.3);">
                                    INFERRED
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin-bottom: 1rem;">
                        <div class="metric-item">
                            <div style="font-size: 0.9rem; color: #cbd5e1; margin-bottom: 0.25rem;">💻 CPU</div>
                            <div style="font-size: 1rem; color: ${getUsageColor(cpuUsage)}; font-weight: 700;">
                                ${cpuUsage}
                            </div>
                        </div>
                        
                        <div class="metric-item">
                            <div style="font-size: 0.9rem; color: #cbd5e1; margin-bottom: 0.25rem;">🧠 MEMORY</div>
                            <div style="font-size: 1rem; color: ${getUsageColor(memoryUsage)}; font-weight: 700;">
                                ${memoryUsage} / ${memoryLimit}
                            </div>
                        </div>
                        
                        <div class="metric-item">
                            <div style="font-size: 0.9rem; color: #cbd5e1; margin-bottom: 0.25rem;">🌐 NETWORK</div>
                            <div style="font-size: 1rem; color: #67e8f9; font-weight: 700;">
                                ${networkIO}
                            </div>
                        </div>
                        
                        <div class="metric-item">
                            <div style="font-size: 0.9rem; color: #cbd5e1; margin-bottom: 0.25rem;">🔄 RESTARTS</div>
                            <div style="font-size: 1rem; color: ${restartCount > 0 ? '#fcd34d' : '#6ee7b7'}; font-weight: 700;">
                                ${restartCount}
                            </div>
                        </div>
                        
                        <div class="metric-item">
                            <div style="font-size: 0.9rem; color: #cbd5e1; margin-bottom: 0.25rem;">❌ FAILURES</div>
                            <div style="font-size: 0.1rem; color: ${health.failures > 0 ? '#fca5a5' : '#6ee7b7'}; font-weight: 700;">
                                ${health.failures || 0}
                            </div>
                        </div>
                        
                        <div class="metric-item">
                            <div style="font-size: 0.9rem; color: #cbd5e1; margin-bottom: 0.25rem;">📊 PROCESSES</div>
                            <div style="font-size: 1rem; color: #67e8f9; font-weight: 700;">
                                ${pids}
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn" style="font-size: 0.8rem; padding: 0.4rem 0.75rem; flex: 1;" 
                                onclick="startContainer('${containerName}')"
                                ${basicInfo.status && basicInfo.status.toLowerCase().includes('running') ? 'disabled' : ''}>
                            ▶️ Start
                        </button>
                        <button class="btn btn-warning" style="font-size: 0.8rem; padding: 0.4rem 0.75rem; flex: 1;" 
                                onclick="restartContainer('${containerName}')"
                                ${!(basicInfo.status && basicInfo.status.toLowerCase().includes('running')) ? 'disabled' : ''}>
                            🔄 Restart
                        </button>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        healthContainer.innerHTML = html;
    }

    function getHealthStatusIcon(status) {
        const statusLower = status.toLowerCase();
        if (statusLower === 'healthy' || statusLower === 'running') return '✅';
        if (statusLower === 'unhealthy' || statusLower === 'exited') return '❌';
        if (statusLower === 'starting' || statusLower === 'created') return '🔄';
        return '❓';
    }

    function getHealthStatusColor(status) {
        const statusLower = status.toLowerCase();
        if (statusLower === 'healthy' || statusLower === 'running') return '#10b981';
        if (statusLower === 'unhealthy' || statusLower === 'exited') return '#ef4444';
        if (statusLower === 'starting' || statusLower === 'created') return '#3b82f6';
        return '#94a3b8';
    }

    function getUsageColor(usage) {
        if (typeof usage === 'string') {
            const percentMatch = usage.match(/(\d+\.?\d*)%/);
            if (percentMatch) {
                const percent = parseFloat(percentMatch[1]);
                if (percent > 80) return '#fca5a5';
                if (percent > 60) return '#fcd34d';
                return '#6ee7b7';
            }
        }
        return '#67e8f9';
    }

    function startHealthMonitoring() {
        if (healthMonitorInterval) {
            clearInterval(healthMonitorInterval);
        }
        healthMonitorInterval = setInterval(refreshHealth, 3000);
        refreshHealth();
    }

    function stopHealthMonitoring() {
        if (healthMonitorInterval) {
            clearInterval(healthMonitorInterval);
            healthMonitorInterval = null;
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(refreshHealth, 1000);
    });
  </script>
</body>
</html>
