<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AutoPod Dashboard</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background-color: #0b0c10;
      color: #c5c6c7;
      margin: 0;
      padding: 20px;
    }
    h1 {
      color: #66fcf1;
      text-align: center;
    }
    .section {
      background-color: #1f2833;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
    }
    pre {
      background-color: #0b0c10;
      padding: 10px;
      border-radius: 8px;
      overflow-x: auto;
      color: #45a29e;
      max-height: 400px;
      overflow-y: auto;
    }
    .status-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #2c3e50;
    }
    .status-name {
      font-weight: bold;
      color: #66fcf1;
    }
    .status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }
    .status-running {
      background-color: #2ecc71;
      color: #0b0c10;
    }
    .status-exited {
      background-color: #e74c3c;
      color: white;
    }
    .status-created {
      background-color: #3498db;
      color: white;
    }
    .status-paused {
      background-color: #f39c12;
      color: white;
    }
    .status-unknown {
      background-color: #95a5a6;
      color: white;
    }
    .btn {
      background: #66fcf1;
      color: #0b0c10;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      margin: 5px;
      transition: all 0.3s ease;
    }
    .btn:hover {
      background: #45a29e;
      transform: translateY(-2px);
    }
    .btn:disabled {
      background: #4a5f68;
      cursor: not-allowed;
      transform: none;
    }
    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .sync-status {
      margin-top: 10px;
      padding: 8px;
      border-radius: 4px;
      font-weight: bold;
    }
    .status-success {
      background-color: rgba(46, 204, 113, 0.2);
      color: #2ecc71;
      border: 1px solid #2ecc71;
    }
    .status-error {
      background-color: rgba(231, 76, 60, 0.2);
      color: #e74c3c;
      border: 1px solid #e74c3c;
    }
    .status-info {
      background-color: rgba(52, 152, 219, 0.2);
      color: #3498db;
      border: 1px solid #3498db;
    }
    .last-updated {
      text-align: right;
      font-size: 12px;
      color: #7f8c8d;
      margin-top: 10px;
    }
    .container-count {
      background-color: #66fcf1;
      color: #0b0c10;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 12px;
      margin-left: 10px;
    }
    .repo-input {
      display: flex;
      gap: 10px;
      margin: 15px 0;
    }
    .repo-input input {
      flex: 1;
      padding: 12px;
      border: 2px solid #45a29e;
      border-radius: 6px;
      background: #0b0c10;
      color: #c5c6c7;
      font-size: 14px;
    }
    .repo-input input:focus {
      outline: none;
      border-color: #66fcf1;
      box-shadow: 0 0 10px rgba(102, 252, 241, 0.3);
    }
    .repo-input button {
      background: #45a29e;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
    }
    .repo-input button:hover {
      background: #66fcf1;
      transform: translateY(-2px);
    }
    .repo-input button:disabled {
      background: #4a5f68;
      cursor: not-allowed;
      transform: none;
    }
    .deployment-status {
      margin-top: 15px;
      padding: 12px;
      border-radius: 6px;
    }
    .access-link {
      color: #66fcf1;
      text-decoration: none;
      margin-left: 10px;
    }
    .access-link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <h1>üöÄ AutoPod Intelligent Container Dashboard</h1>

  <div class="section">
    <h2>Deploy New Repository</h2>
    <div class="repo-input">
      <input type="text" id="repo-url" placeholder="https://github.com/username/repository.git" />
      <button onclick="deployRepository()" id="deploy-btn">üöÄ Deploy Repository</button>
    </div>
    <div id="deployment-status" class="deployment-status"></div>
  </div>

  <div class="section">
    <h2>Actions</h2>
    <div class="actions">
      <button class="btn" onclick="syncContainers()" id="sync-btn">
        üîÑ Sync Containers
      </button>
      <button class="btn" onclick="refreshData()" id="refresh-btn">
        üìä Refresh Data
      </button>
      <button class="btn" onclick="clearLogs()" id="clear-logs-btn">
        üßπ Clear Logs Display
      </button>
    </div>
    <div id="sync-status" class="sync-status"></div>
    <div id="last-updated" class="last-updated"></div>
  </div>

  <div class="section">
    <h2>
      Container Status 
      <span id="container-count" class="container-count">0</span>
    </h2>
    <div id="status">Loading...</div>
  </div>

  <div class="section">
    <h2>Container Logs</h2>
    <pre id="logs">Loading...</pre>
  </div>

  <script>
    let lastUpdateTime = null;

    function getStatusBadge(status) {
      const statusLower = status.toLowerCase();
      if (statusLower.includes('up') || statusLower.includes('running')) {
        return 'status-running';
      } else if (statusLower.includes('exited') || statusLower.includes('stopped')) {
        return 'status-exited';
      } else if (statusLower.includes('created')) {
        return 'status-created';
      } else if (statusLower.includes('paused')) {
        return 'status-paused';
      } else {
        return 'status-unknown';
      }
    }

    function getStatusText(status) {
      const statusLower = status.toLowerCase();
      if (statusLower.includes('up') || statusLower.includes('running')) {
        return 'Running';
      } else if (statusLower.includes('exited') || statusLower.includes('stopped')) {
        return 'Exited';
      } else if (statusLower.includes('created')) {
        return 'Created';
      } else if (statusLower.includes('paused')) {
        return 'Paused';
      } else {
        return status;
      }
    }

    function updateLastUpdated() {
      lastUpdateTime = new Date();
      const lastUpdatedDiv = document.getElementById('last-updated');
      lastUpdatedDiv.textContent = `Last updated: ${lastUpdateTime.toLocaleTimeString()}`;
    }

    async function deployRepository() {
      const repoUrl = document.getElementById('repo-url').value.trim();
      const deployBtn = document.getElementById('deploy-btn');
      const statusDiv = document.getElementById('deployment-status');

      if (!repoUrl) {
        statusDiv.className = 'deployment-status status-error';
        statusDiv.innerHTML = '‚ùå Please enter a repository URL';
        return;
      }

      // Basic GitHub URL validation
      if (!repoUrl.includes('github.com') || !repoUrl.endsWith('.git')) {
        statusDiv.className = 'deployment-status status-error';
        statusDiv.innerHTML = '‚ùå Please enter a valid GitHub repository URL (should end with .git)';
        return;
      }

      deployBtn.disabled = true;
      deployBtn.innerHTML = '‚è≥ Deploying...';
      statusDiv.className = 'deployment-status status-info';
      statusDiv.innerHTML = 'üöÄ Starting deployment...';

      try {
        // Extract repository name from URL
        const repoName = extractRepoName(repoUrl);
        
        const response = await fetch('/webhook', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            repository: {
              clone_url: repoUrl,
              name: repoName
            }
          })
        });

        const result = await response.json();

        if (result.status === 'success') {
          statusDiv.className = 'deployment-status status-success';
          statusDiv.innerHTML = `
            ‚úÖ ${result.message}
            ${result.access_url ? `<br><a href="${result.access_url}" target="_blank" class="access-link">üåê Open Application</a>` : ''}
          `;
          
          // Clear input field
          document.getElementById('repo-url').value = '';
          
          // Refresh data after deployment
          setTimeout(fetchData, 2000);
        } else {
          statusDiv.className = 'deployment-status status-error';
          statusDiv.innerHTML = `‚ùå ${result.message}`;
        }
      } catch (err) {
        statusDiv.className = 'deployment-status status-error';
        statusDiv.innerHTML = `‚ùå Deployment failed: ${err.message}`;
      } finally {
        deployBtn.disabled = false;
        deployBtn.innerHTML = 'üöÄ Deploy Repository';
        
        // Clear status after 10 seconds
        setTimeout(() => {
          statusDiv.innerHTML = '';
          statusDiv.className = 'deployment-status';
        }, 10000);
      }
    }

    function extractRepoName(repoUrl) {
      // Extract repository name from GitHub URL
      // Example: https://github.com/username/repo.git -> repo
      const matches = repoUrl.match(/github\.com\/([^\/]+\/[^\/\.]+)/);
      if (matches && matches[1]) {
        return matches[1].split('/')[1]; // Get only the repo name
      }
      // Fallback: use last part of URL
      return repoUrl.split('/').pop().replace('.git', '') || 'webhook-app';
    }

    async function syncContainers() {
      const syncBtn = document.getElementById('sync-btn');
      const statusDiv = document.getElementById('sync-status');
      
      syncBtn.disabled = true;
      syncBtn.innerHTML = '‚è≥ Syncing...';
      statusDiv.className = 'sync-status status-info';
      statusDiv.innerHTML = 'Syncing containers with database...';
      
      try {
        const response = await fetch('/api/sync', { 
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        const result = await response.json();
        
        if (result.success) {
          statusDiv.className = 'sync-status status-success';
          statusDiv.innerHTML = '‚úÖ Sync successful! Refreshing data...';
          
          // Refresh data after successful sync
          setTimeout(() => {
            fetchData();
            statusDiv.innerHTML = '‚úÖ Sync completed successfully';
          }, 1000);
        } else {
          statusDiv.className = 'sync-status status-error';
          statusDiv.innerHTML = `‚ùå Sync failed: ${result.error}`;
        }
      } catch (err) {
        statusDiv.className = 'sync-status status-error';
        statusDiv.innerHTML = `‚ùå Sync error: ${err.message}`;
      } finally {
        syncBtn.disabled = false;
        syncBtn.innerHTML = 'üîÑ Sync Containers';
        
        // Clear status message after 5 seconds
        setTimeout(() => {
          statusDiv.innerHTML = '';
          statusDiv.className = 'sync-status';
        }, 5000);
      }
    }

    function refreshData() {
      const refreshBtn = document.getElementById('refresh-btn');
      refreshBtn.disabled = true;
      refreshBtn.innerHTML = '‚è≥ Refreshing...';
      
      fetchData();
      
      setTimeout(() => {
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = 'üìä Refresh Data';
      }, 1000);
    }

    function clearLogs() {
      const logsPre = document.getElementById('logs');
      logsPre.textContent = 'Logs cleared. New logs will appear here...';
    }

    async function fetchData() {
      try {
        const [statusRes, logsRes] = await Promise.all([
          fetch('http://127.0.0.1:5000/api/status'),
          fetch('http://127.0.0.1:5000/api/logs')
        ]);

        const statusData = await statusRes.json();
        const logsData = await logsRes.json();

        // Status Section
        const statusDiv = document.getElementById('status');
        const containerCount = document.getElementById('container-count');
        
        if (statusData.success && statusData.data.length > 0) {
          containerCount.textContent = statusData.data.length;
          statusDiv.innerHTML = `
            <div>
              ${statusData.data.map(s => `
                <div class="status-item">
                  <span class="status-name">${s['container_name']}</span>
                  <span class="status-badge ${getStatusBadge(s['status'])}">
                    ${getStatusText(s['status'])}
                  </span>
                </div>
              `).join('')}
            </div>
          `;
        } else {
          containerCount.textContent = '0';
          statusDiv.innerHTML = '<p>No containers found. Click "Sync Containers" to refresh.</p>';
        }

        // Logs Section
        const logsPre = document.getElementById('logs');
        if (logsData.success && logsData.data.length > 0) {
          logsPre.textContent = logsData.data.map(l => 
            `[${l['timestamp']}] ${l['container_name'] || 'unknown'}: ${l['log']}`
          ).join('\n');
          // Auto-scroll to bottom of logs
          logsPre.scrollTop = logsPre.scrollHeight;
        } else {
          logsPre.textContent = 'No logs available. Containers might not be running or no sync has been performed.';
        }

        updateLastUpdated();

      } catch (err) {
        console.error('Error fetching data:', err);
        document.getElementById('status').innerHTML = 
          '<p style="color: #e74c3c;">Error loading container status. Check if the server is running.</p>';
        document.getElementById('logs').textContent = 'Error loading logs. Check console for details.';
        document.getElementById('container-count').textContent = '0';
        
        const statusDiv = document.getElementById('sync-status');
        statusDiv.className = 'sync-status status-error';
        statusDiv.innerHTML = '‚ùå Connection error. Make sure the backend server is running on port 5000.';
      }
    }

    // Add Enter key support for repository input
    document.getElementById('repo-url').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        deployRepository();
      }
    });

    // Fetch data every 5 seconds
    fetchData();
    setInterval(fetchData, 5000);

    // Initial update time
    updateLastUpdated();
  </script>
</body>
</html>